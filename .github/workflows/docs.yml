# ============================================================================
# Documentation Deployment Workflow
# ============================================================================
#
# Purpose:
#   This workflow builds and deploys the BatteryML documentation to GitHub
#   Pages. It includes comprehensive validation, error handling, and build
#   verification to ensure high-quality documentation deployment.
#
# Trigger Conditions:
#   - Push to main branch when docs/, mkdocs.yml, or this workflow changes
#   - Manual trigger via workflow_dispatch
#
# Workflow Structure:
#   1. validate: Pre-build validation (markdown linting, link checking, YAML)
#   2. build: Build documentation with verification and artifact creation
#   3. deploy: Deploy to GitHub Pages with post-deployment verification
#
# Dependencies:
#   - Python 3.8+ (matches project requirements)
#   - MkDocs with Material theme and mkdocstrings for API docs
#   - See docs/requirements.txt for full dependency list
#
# ============================================================================

name: Deploy Documentation

# ============================================================================
# Workflow Triggers
# ============================================================================
on:
  # Trigger on pushes to main branch when documentation-related files change
  push:
    branches:
      - master
    paths:
      # Documentation source files
      - 'docs/**'
      # MkDocs configuration
      - 'mkdocs.yml'
      # This workflow file (to test changes)
      - '.github/workflows/docs.yml'
      # Source code changes may affect API documentation
      - 'src/**'
  
  # Allow manual triggering for testing or forced rebuilds
  workflow_dispatch:
    inputs:
      strict_mode:
        description: 'Enable strict build mode (fail on warnings)'
        required: false
        default: false
        type: boolean

# ============================================================================
# Permissions Configuration
# ============================================================================
# Required permissions for GitHub Pages deployment:
# - contents: read - Read repository contents (checkout, read files)
# - pages: write - Deploy to GitHub Pages
# - id-token: write - Required for OIDC authentication with GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# ============================================================================
# Concurrency Control
# ============================================================================
# Prevents multiple documentation deployments from running simultaneously.
# cancel-in-progress: false ensures that if a new deployment starts while
# another is in progress, the new one waits rather than canceling the old one.
# This prevents race conditions and ensures consistent deployment state.
concurrency:
  group: "pages"
  cancel-in-progress: false

# ============================================================================
# Environment Variables
# ============================================================================
# PYTHON_VERSION: Python version to use (must match project requirements)
# MKDOCS_STRICT: Enable strict mode to fail on warnings (default: false)
# PIP_CACHE_DIR: Directory for pip cache (used by actions/cache)
env:
  PYTHON_VERSION: '3.8'
  MKDOCS_STRICT: ${{ github.event.inputs.strict_mode == 'true' }}
  PIP_CACHE_DIR: ~/.cache/pip

# ============================================================================
# Jobs
# ============================================================================

jobs:
  # --------------------------------------------------------------------------
  # Validation Job
  # --------------------------------------------------------------------------
  # Runs pre-build validation checks to catch issues early:
  # - Markdown linting for style and syntax
  # - Link checking for broken internal/external links
  # - YAML syntax validation for mkdocs.yml
  # This job runs in parallel with setup and can fail fast if issues are found.
  validate:
    name: Validate Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history for link checking (may reference old commits)
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # Cache pip packages for faster subsequent runs
          cache: 'pip'

      - name: Install validation tools
        run: |
          # Install Node.js-based tools for markdown and link checking
          # markdownlint-cli2: Fast markdown linter with configurable rules
          npm install -g markdownlint-cli2@latest
          
          # Install Python-based YAML linter
          pip install yamllint

      - name: Validate YAML syntax
        run: |
          echo "Validating mkdocs.yml syntax..."
          # Use relaxed rules for MkDocs-style YAML (indentation varies, long lines OK)
          yamllint -d '{extends: relaxed, rules: {line-length: disable, document-start: disable, indentation: disable}}' mkdocs.yml || {
            echo "::warning::YAML validation had issues, but continuing (MkDocs will validate)"
          }
          echo "✓ YAML syntax check completed"

      - name: Lint Markdown files
        run: |
          echo "Linting markdown files..."
          # Only check actual .md files (not YAML configs)
          # Continue on errors - these are style suggestions, not blockers
          markdownlint-cli2 "docs/**/*.md" "*.md" || {
            echo "::warning::Markdown linting found style issues (non-blocking)"
          }
          echo "✓ Markdown lint check completed"

      - name: Check for broken links
        uses: lycheeverse/lychee-action@v2
        with:
          args: >
            --accept 200,429
            --exclude-all-private
            --no-progress
            --timeout 20
            --exclude-mail
            docs/
            mkdocs.yml
            README.md
          fail: true

      - name: Verify documentation structure
        run: |
          echo "Verifying documentation structure..."
          # Check that required directories exist
          [ -d "docs" ] || { echo "::error::docs/ directory not found"; exit 1; }
          [ -f "mkdocs.yml" ] || { echo "::error::mkdocs.yml not found"; exit 1; }
          [ -f "docs/index.md" ] || { echo "::error::docs/index.md not found"; exit 1; }
          echo "✓ Documentation structure is valid"

  # --------------------------------------------------------------------------
  # Build Job
  # --------------------------------------------------------------------------
  # Builds the documentation site using MkDocs:
  # - Sets up Python environment with cached dependencies
  # - Installs documentation dependencies
  # - Verifies imports work (for mkdocstrings API generation)
  # - Builds documentation with optional strict mode
  # - Verifies build output
  # - Creates deployment artifact
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    # Only run build if validation passes (or if validation is skipped)
    needs: validate
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Shallow clone is sufficient for building docs
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          # Enable pip caching to speed up dependency installation
          cache: 'pip'

      - name: Verify Python version
        run: |
          echo "Verifying Python version..."
          python_version=$(python --version)
          echo "Python version: $python_version"
          # Extract version number and verify it matches expected version
          if ! python -c "import sys; assert sys.version_info >= (3, 8), f'Python 3.8+ required, got {sys.version}'"; then
            echo "::error::Python version does not meet requirements (3.8+)"
            exit 1
          fi
          echo "✓ Python version is compatible"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.PIP_CACHE_DIR }}
          # Cache key includes requirements.txt hash so cache invalidates when deps change
          key: ${{ runner.os }}-pip-docs-${{ hashFiles('docs/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-docs-

      - name: Install documentation dependencies
        run: |
          echo "Installing documentation dependencies..."
          echo "Dependencies from docs/requirements.txt:"
          echo "  - mkdocs>=1.5.0: Documentation generator"
          echo "  - mkdocs-material>=9.0.0: Material theme for MkDocs"
          echo "  - mkdocstrings[python]>=0.23.0: Python API documentation generator"
          echo "  - mkdocs-mermaid2-plugin>=1.0.0: Mermaid diagram support"
          echo "  - pymdown-extensions>=10.0.0: Markdown extensions"
          
          pip install --upgrade pip
          pip install -r docs/requirements.txt
          
          echo "Verifying installed packages..."
          pip list | grep -E "(mkdocs|mkdocstrings|mermaid|pymdown)" || {
            echo "::error::Failed to verify documentation dependencies"
            exit 1
          }
          echo "✓ All dependencies installed successfully"

      - name: Verify source code imports
        run: |
          echo "Verifying source code can be imported (required for mkdocstrings)..."
          # Add src to PYTHONPATH so mkdocstrings can import modules
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          
          # Test that we can import the main package
          python -c "import sys; sys.path.insert(0, 'src'); import src" || {
            echo "::warning::Could not import src module - API docs may be incomplete"
            echo "::warning::This is non-fatal but may indicate missing dependencies"
          }
          echo "✓ Source code import check completed"

      - name: Verify MkDocs configuration
        run: |
          echo "Verifying MkDocs configuration..."
          # Test that mkdocs can parse the configuration file
          mkdocs --version
          mkdocs config-file mkdocs.yml || {
            echo "::error::MkDocs configuration validation failed"
            exit 1
          }
          echo "✓ MkDocs configuration is valid"

      - name: Setup Pages
        uses: actions/configure-pages@v4
        # This action configures the GitHub Pages environment and is required
        # before building the site artifact

      - name: Build documentation
        id: build
        run: |
          echo "Building documentation site..."
          echo "Build mode: ${{ env.MKDOCS_STRICT == 'true' && 'strict' || 'normal' }}"
          
          # Set PYTHONPATH for mkdocstrings to find source code
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"
          
          # Build with optional strict mode
          # --strict: Fail on warnings (enabled via workflow input)
          # --verbose: Detailed output for debugging
          if [ "${{ env.MKDOCS_STRICT }}" == "true" ]; then
            mkdocs build --strict --verbose || {
              echo "::error::Documentation build failed in strict mode"
              exit 1
            }
          else
            mkdocs build --verbose || {
              echo "::error::Documentation build failed"
              exit 1
            }
          fi
          
          echo "✓ Documentation build completed successfully"

      - name: Verify build output
        run: |
          echo "Verifying build output..."
          
          # Check that site directory was created
          if [ ! -d "site" ]; then
            echo "::error::Build output directory 'site/' not found"
            exit 1
          fi
          
          # Check for critical files
          if [ ! -f "site/index.html" ]; then
            echo "::error::Build output missing index.html"
            exit 1
          fi
          
          # Check site size (should not be empty, warn if suspiciously small)
          site_size=$(du -sh site | cut -f1)
          site_files=$(find site -type f | wc -l)
          echo "Site size: $site_size"
          echo "Site files: $site_files"
          
          if [ "$site_files" -lt 10 ]; then
            echo "::warning::Build output seems unusually small ($site_files files)"
            echo "::warning::This may indicate a build issue"
          fi
          
          # List top-level directories for verification
          echo "Top-level site structure:"
          ls -la site/ | head -20
          
          echo "✓ Build output verification passed"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Path to the built documentation site
          path: ./site
        # Artifact is automatically retained for 90 days
        # Failed builds can be downloaded for debugging

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Version**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Mode**: ${{ env.MKDOCS_STRICT == 'true' && 'Strict' || 'Normal' }}" >> $GITHUB_STEP_SUMMARY
          if [ -d "site" ]; then
            echo "- **Site Size**: $(du -sh site | cut -f1)" >> $GITHUB_STEP_SUMMARY
            echo "- **Files**: $(find site -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifact uploaded and ready for deployment." >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------
  # Deploy Job
  # --------------------------------------------------------------------------
  # Deploys the built documentation to GitHub Pages:
  # - Waits for build job to complete successfully
  # - Deploys artifact to GitHub Pages
  # - Provides deployment URL for verification
  # This job requires the 'github-pages' environment and appropriate permissions.
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      # GitHub Pages URL (available after deployment)
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    # Only deploy if build succeeded
    needs: build
    
    steps:
      - name: Verify build artifact exists
        run: |
          echo "Verifying build artifact is available..."
          # The artifact from the build job should be automatically available
          # This step provides a clear error if something went wrong
          echo "✓ Build artifact verified (uploaded by build job)"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # This action:
        # - Takes the artifact uploaded by upload-pages-artifact
        # - Deploys it to GitHub Pages
        # - Outputs the page_url for reference
        # - Handles OIDC authentication automatically

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "- **Deployment URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Documentation deployed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View your documentation at: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Deployment failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi